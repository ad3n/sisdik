{% extends 'FastSisdikBundle::layout.html.twig' %}

{% block page_heading %}{% trans from "headings" %}payment.registrationfee.entry{% endtrans %}<br>{{ siswa.namaLengkap }}{% endblock %}

{% block content %}
<style type="text/css">
.content .popover-content p {
    margin-bottom: 0;
}
.popover-title {
    padding: 6px 15px;
}
.popover-content {
    padding: 10px 15px;
}
.popover h3 {
    text-shadow: none;
    font-size: 1.1em;
}
.popover-inner {
    padding: 1px;
    background: none repeat scroll 0 0 rgba(0, 0, 0, 0.2);
    max-width: 160px;
}
#discount-container {
    background-color: #F2F3C9;
}
#fee-amount, #fee-amount-discounted {
    cursor: pointer;
}
#icon-preview {
    margin: 0 4px 0 10px;
}
.keterangan-pembayaran:after {
    content: "{{ 'label.keterangan'|trans }}";
}
</style>

<div class="row-fluid">
    <div class="span12">
        <div class="span8">
            <dl>
                <dt>{{ 'label.year.entry'|trans }}</dt>
                <dd>{% if siswa.tahun is not null %}{{ siswa.tahun.tahun }}{% endif %}</dd>
                <dt>{{ 'label.admissiongroup.entry'|trans }}</dt>
                <dd>{% if siswa.gelombang is not null %}{{ siswa.gelombang.nama }}{% endif %}</dd>
                <dt>{{ 'label.application.number'|trans }}</dt>
                <dd>{{ siswa.nomorPendaftaran }}</dd>
                <dt>{{ 'label.name.full'|trans }}</dt>
                <dd>{{ siswa.namaLengkap }}</dd>
                <dt>{{ 'label.sekolah.asal'|trans }}</dt>
            {% if siswa.sekolahAsal is not null %}
                <dd>
                    <a href="{{ path('sekolahasal_show', { 'id': siswa.sekolahAsal.id }) }}" target="_blank">
                        {{ siswa.sekolahAsal.nama }}
                        {% image '@FastSisdikBundle/Resources/public/images/jump-link.png' %}
                    	    <img src="{{ asset_url }}" alt="{{ 'alt.sekolah.asal'|trans }}" border="0" style="vertical-align: baseline;" />
                        {% endimage %}
                    </a>
                </dd>
            {% else %}
                <dd>&nbsp;</dd>
            {% endif %}
                <dt>{{ 'label.gender'|trans }}</dt>
                <dd>{% if siswa.jenisKelamin == 'L' %}{{ 'male'|trans }}{% elseif siswa.jenisKelamin == 'P' %}{{ 'female'|trans }}{% endif %}</dd>
                <dt>{{ 'label.religion'|trans }}</dt>
                <dd>{{ siswa.agama|title }}</dd>
                <dt>{{ 'label.address'|trans }}</dt>
                <dd>{{ siswa.alamat }}</dd>
            	{% if siswa.orangtuaWali %}
            	    {% for orangtua in siswa.orangtuaWali %}
            	        {% if orangtua %}
            	            {% if orangtua.aktif == 1 %}
                	            <dt>{{ 'label.name.parent.or.guardian'|trans }}</dt>
                	            <dd>{{ orangtua.nama }}</dd>
                	            <dt>{{ 'label.mobilephone.parent'|trans }}</dt>
                	            <dd>{{ orangtua.ponsel }}</dd>
            		        {% endif %}
            	        {% endif %}
            	    {% endfor %}
            	{% endif %}

    		    {% set totalBayar = 0 %}
    		    {% set totalBiayaMasuk = 0 %}
    		    {% set totalPotongan = 0 %}
    		    {% set totalBiayaSisa = 0 %}
    		    {% set totalBiaya = 0 %}

    		    {% for pembayaran in entities %}
    		        {% set totalPotongan = totalPotongan + pembayaran.nominalPotongan + pembayaran.persenPotonganDinominalkan %}
    		        {% for biaya in pembayaran.daftarBiayaPendaftaran %}
                        {% set totalBiayaMasuk = totalBiayaMasuk + biaya.nominal %}
    		        {% endfor %}
    		        {% for transaksi in pembayaran.transaksiPembayaranPendaftaran %}
    		            {% set totalBayar = totalBayar + transaksi.nominalPembayaran %}
    		        {% endfor %}
    		    {% endfor %}

                {% if itemBiayaTersimpan|length != 0 %}
        		    {% set remainInfo %}
        		        {% render url('fee_registration_remains', {'tahun': siswa.tahun.id, 'gelombang': siswa.gelombang.id, 'usedfee': itemBiayaTersimpan|join(','), 'json': 1}) %}
        		    {% endset %}
        		    {% set remainInfo = remainInfo|json_decode %}
        		    {% set totalBiayaSisa = remainInfo.biaya %}
    		    {% else %}
    		        {% set remainInfo %}
                        {% render url('fee_registration_totalinfo', {'tahun': siswa.tahun.id, 'gelombang': siswa.gelombang.id, 'json': 1}) %}
                    {% endset %}
        		    {% set remainInfo = remainInfo|json_decode %}
        		    {% set totalBiayaSisa = remainInfo.biaya %}
    		    {% endif %}
    		    {% set totalBiaya = totalBiayaSisa + (totalBiayaMasuk - totalPotongan) %}

            	<dt>{{ 'label.payables.amount.total'|trans }}</dt>
            	<dd>
        	    {% if totalPotongan > 0 %}
        	        <span class="icon-gift" style="margin: 0;" title="{{ 'label.discounted.fee'|trans }}"></span>
    	        {% endif %}
    	        {{ totalBiaya|number_format(0, ',', '.') }}
    	        </dd>
            	<dt>{{ 'label.paid.amount.total'|trans }}</dt>
            	<dd>{{ totalBayar|number_format(0, ',', '.') }}</dd>
            	<dt>{{ 'label.payment.remains.total'|trans }}</dt>
            	<dd>
    	            {{ (totalBiayaSisa + (totalBiayaMasuk - totalPotongan - totalBayar))|number_format(0, ',', '.') }}
            	</dd>
            </dl>
        </div>
        <div class="span4">
            {% if siswa.keterangan is not null %}<div class="keterangan-pembayaran" style="min-width: 80%;">{{ siswa.keterangan }}</div><div class="clearfix"></div>{% endif %}
            {% if siswa.webcamPhotoPath != "" %}
                <img src="{% if proxypass == 1 %}/{{ proxypassname }}{% endif %}/{{ siswa.webcamPhotoPath }}" class="img-polaroid" width="180" />
            {% endif %}
        </div>
    </div>
</div>

<div class="clearfix" style="margin-bottom: 2em;"></div>

<h4>{{ 'label.fee.registration.paid'|trans }}</h4>

<table class="table zebra-striped bordered-table" id="no-more-tables">
    <thead>
    	<tr>
    		<th>{{ 'label.fee.registration.entry'|trans }}</th>
    		<th style="white-space: nowrap">{{ 'label.payables.amount'|trans }}</th>
    		<th style="white-space: nowrap">{{ 'label.paid.amount'|trans }}</th>
    		<th>{{ 'label.actions'|trans }}</th>
    	</tr>
	</thead>
	<tbody>
    {% for pembayaran in entities %}
        <tr>
    		<td data-title="{{ 'label.fee.registration.entry'|trans }}">
    		{% set subTotalItemBiaya = 0 %}
		    {% if pembayaran.daftarBiayaPendaftaran %}
    		    {% for biaya in pembayaran.daftarBiayaPendaftaran %}
    		        {% if biaya != '' %}
    		            {{ biaya.nama }} ({{ biaya.nominal|number_format(0, ',', '.') }}){% if not loop.last %}, {% endif %}
    		            {% set subTotalItemBiaya = subTotalItemBiaya + biaya.nominal %}
    		        {% endif %}
    		    {% endfor %}
		    {% endif %}
		    </td>
    		<td data-title="{{ 'label.payables.amount'|trans }}">
        		{% if pembayaran.nominalPotongan > 0 or pembayaran.persenPotonganDinominalkan > 0 %}
        		    <span class="icon-gift" style="margin: 0;" title="{{ 'label.discounted.fee'|trans }}"></span>
    		    {% endif %}
    		    {{ (subTotalItemBiaya - (pembayaran.nominalPotongan + pembayaran.persenPotonganDinominalkan))|number_format(0, ',', '.') }}
    		</td>
    		<td data-title="{{ 'label.paid.amount'|trans }}">{{ pembayaran.totalNominalTransaksiPembayaranPendaftaran|number_format(0, ',', '.') }}</td>
    		<td data-title="{{ 'label.actions'|trans }}" class="row-actions">
    		    <a href="{{ path('payment_registrationfee_show', { 'sid': siswa.id, 'id': pembayaran.id }) }}" title="{{ 'tip.detail'|trans }}" class="icon-arrow-right"></a>
		    {% if pembayaran.transaksiPembayaranPendaftaran|length > 1 %}
		        <a href="#" onclick="return false"
		            title="{{ 'tip.print.receipt'|trans }}" id="popover-{{ pembayaran.id }}">
		            {% image '@FastSisdikBundle/Resources/public/images/print-preview.png' %}
                    	<img src="{{ asset_url }}" id="icon-preview" />
                    {% endimage %}
	            </a>
	            <script language="javascript" type="text/javascript">
	                var popContent =
	                {% for transaksi in pembayaran.transaksiPembayaranPendaftaran %}
                        {% if not loop.last %}
                            "{{ 'label.payment'|trans }} #{{ loop.index }}<a href='{{ path('payment_registrationfee_printreceipt', { 'sid': siswa.id, 'pid': pembayaran.id, 'id': transaksi.id }) }}' class='icon-print'></a><br />" +
                        {% else %}
                            "{{ 'label.payment'|trans }} #{{ loop.index }}<a href='{{ path('payment_registrationfee_printreceipt', { 'sid': siswa.id, 'pid': pembayaran.id, 'id': transaksi.id }) }}' class='icon-print'></a>"
                        {% endif %}
                    {% endfor %}
	                $("#popover-" + {{ pembayaran.id }}).popover({
	                    "placement": "right",
	                    "html": true,
	                    "content": popContent
		            });
	            </script>
	        {% else %}
	            {% for transaksi in pembayaran.transaksiPembayaranPendaftaran %}
    		    <a href="{{ path('payment_registrationfee_printreceipt', { 'sid': siswa.id, 'pid': pembayaran.id, 'id': transaksi.id }) }}"
    		        title="{{ 'tip.print.receipt'|trans }}" class="icon-print"></a>
		        {% endfor %}
		    {% endif %}
		    {% if pembayaran.totalNominalTransaksiPembayaranPendaftaran < (subTotalItemBiaya - (pembayaran.nominalPotongan + pembayaran.persenPotonganDinominalkan)) %}
        		<a href="{{ path('payment_registrationfee_edit', { 'sid': siswa.id, 'id': pembayaran.id }) }}" title="{{ 'tip.payment.registrationfee.mortgage'|trans }}" class="icon-shopping-cart"></a>
		    {% endif %}
    		</td>
    	</tr>
    {% endfor %}
    </tbody>
</table>

<div class="clearfix"></div>

{% if itemBiayaSemua|length > itemBiayaTersimpan|length %}
<form id="pay-form" action="{{ path('payment_registrationfee_create', { 'sid': siswa.id }) }}" method="post" {{ form_enctype(form) }} class="form-horizontal">
    {{ form_row(form.daftarBiayaPendaftaran) }}
    <div class="control-group">
        <div class="controls">
            {{ 'label.payables.amount'|trans }} <b>{{ currencySymbol(locale) }}. <span id="fee-amount"></span></b>
        </div>
    </div>
    {{ form_row(form.adaPotongan) }}
    <div id="discount-container">
        <div id="discount-type">{{ form_row(form.jenisPotongan) }}</div>
        <div id="discount-percentage">{{ form_row(form.persenPotongan) }}</div>
        <div id="discount-amount">{{ form_row(form.nominalPotongan) }}</div>
        <div class="control-group">
            <div class="controls">
                {{ 'label.payables.amount.discounted'|trans }} <b>{{ currencySymbol(locale) }}. <span id="fee-amount-discounted"></span></b>
            </div>
        </div>
    </div>
    <div class="control-group">
        {{ form_widget(form.transaksiPembayaranPendaftaran) }}
    </div>
    {{ form_rest(form) }}
    <div class="control-group">
        <p style="font-style: italic; font-size: 0.9em;">
            {{ 'shortinfo.pay.notbiggerthan.fee'|trans }}<br />
            {{ 'shortinfo.pay.lessthan.fee.oneitem'|trans }}
        </p>
    </div>
    <div class="form-actions">
    <button type="submit" class="btn primary">{{ 'label.save'|trans }}</button>
    </div>
</form>
{% endif %}

<div class="clearfix"></div>

<ul class="pills">
    <li>
        <a href="{{ path('applicant_payment') }}">{{ 'link.backtolist'|trans }}</a>
    </li>
</ul>
<script language="javascript" type="text/javascript">
var duration = 400;
var total = 0;
var amount;
var totaldiscounted = 0;
var amountdiscounted;
var withdiscount = false;
var type;
var discountpercent = 0;
var discountnominal = 0;

function getTotalFee(index, element) {
	var checkbox = $(this);
	if (checkbox.is(":checked")) {
		var num = 0;

		str = $.trim($(this).parent().text().split('.').join(''));
        num = str.match(/\d+$/);
        total += parseInt(num);
	}
}

function getTotalFeeDiscounted() {
	if ($(".discount-check").is(":checked")) {
        type = $("#discount-type input[type='radio']:checked").val();
        if (type == 'nominal') {
            totaldiscounted = total - $.trim($(".nominal-discount").val().split('.').join('')).match(/\d+$/);
            totaldiscounted = totaldiscounted <= 0 ? 0 : totaldiscounted;
        } else if (type == 'persentase') {
            discountpercent = $.trim($(".percentage-discount").val().split('.').join('')).match(/\d+$/);
            totaldiscounted = total - (total * (discountpercent / 100));
        }
	} else {
		totaldiscounted = 0;
	}
}

$(document).ready(function() {
	$(".discount-check").change(function(){
		if ($(this).is(":checked")) {
			$('#discount-container').show(duration);
		} else {
			$('#discount-container').hide(duration);
			$(".percentage-discount").val("");
			$(".nominal-discount").val("");
			$("#fee-amount-discounted").text("");
		}
	});
	if ($(".discount-check").is(":checked")) {
	    $('#discount-container').show(duration);
	} else {
		$('#discount-container').hide(duration);
		$(".percentage-discount").val("");
		$(".nominal-discount").val("");
		$("#fee-amount-discounted").text("");
	}

	$("#discount-type input[type='radio']").change(function(){
		$("#fee-amount-discounted").text("");
		type = $("#discount-type input[type='radio']:checked").val();
		if (type == 'nominal') {
			$("#discount-percentage").hide(duration);
			$("#discount-amount").show(duration);
			$(".percentage-discount").val("");
		} else if (type == 'persentase') {
			$("#discount-percentage").show(duration);
			$("#discount-amount").hide(duration);
			$(".nominal-discount").val("");
		}
	});
	$("#fee-amount-discounted").text("");
	type = $("#discount-type input[type='radio']:checked").val();
	if (type == 'nominal') {
		$("#discount-percentage").hide(duration);
		$("#discount-amount").show(duration);
		$(".percentage-discount").val("");

		discountnominal = $("#discount-amount").val();
	} else if (type == 'persentase') {
		$("#discount-percentage").show(duration);
		$("#discount-amount").hide(duration);
		$(".nominal-discount").val("");

		discountpercent = $("#discount-percentage").val();
	} else {
		$("#discount-percentage").hide();
		$("#discount-amount").hide();
		$(".percentage-discount").val("");
		$(".nominal-discount").val("");
	}

	// display total fee
	$(".fee-item").each(getTotalFee);
	amount = total.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
    $("#fee-amount").text(amount);

    $("form .fee-item").change(function() {
    	total = 0;
    	$(".fee-item").each(getTotalFee);

    	amount = total.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        $("#fee-amount").text(amount);

    	getTotalFeeDiscounted();
        totaldiscounted = totaldiscounted.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        $("#fee-amount-discounted").text(totaldiscounted);
    });

    $("#fee-amount").click(function() {
        $(".pay-amount").val($(this).text());
    });
    // end of display total fee

    // find and display discounted fee
    getTotalFeeDiscounted();
    amountdiscounted = totaldiscounted.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
    $("#fee-amount-discounted").text(amountdiscounted == "0" ? "" : amountdiscounted);

    $(".nominal-discount").keyup(function() {
        discountnominal = $.trim($(this).val().split('.').join('')).match(/\d+$/);
        totaldiscounted = total - discountnominal;

        amountdiscounted = totaldiscounted.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        $("#fee-amount-discounted").text(amountdiscounted);
    });
    $(".percentage-discount").keyup(function() {
        discountpercent = $.trim($(this).val().split('.').join('')).match(/\d+$/);
        totaldiscounted = total - (total * (discountpercent / 100));

        amountdiscounted = totaldiscounted.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        $("#fee-amount-discounted").text(amountdiscounted);
    });

    $("#fee-amount-discounted").click(function() {
        $(".pay-amount").val($(this).text());
    });
    // end of find and display discounted fee

    $("#pay-form").submit(function() {
    	$(this).find(':submit').attr('disabled','disabled');

        var payamount = parseInt($(".pay-amount").val().split('.').join(''));

        total = 0;
        $(".fee-item").each(getTotalFee);
        amount = total.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        $("#fee-amount").text(amount);
        var feeamount = total;

        totaldiscounted = 0;
        getTotalFeeDiscounted();
        amountdiscounted = totaldiscounted.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        $("#fee-amount-discounted").text(amountdiscounted == "0" ? "" : amountdiscounted);
        var feeamountdiscounted = totaldiscounted;

        var withdiscount = ($(".discount-check").is(":checked"));

        // debug
        /*
        console.log("withdiscount: " + withdiscount);
        console.log("feeamount: " + feeamount);
        console.log("feeamountdiscounted: " + feeamountdiscounted);
        console.log("payamount: " + payamount);
        */

        if (withdiscount) {
            if (payamount > feeamountdiscounted) {
                alert("{{ 'shortinfo.pay.notbiggerthan.fee.discounted'|trans }}");
                $(this).find(':submit').removeAttr('disabled');
                return false;
            } else if ((feeamount - feeamountdiscounted) <= 0) {
                alert("{{ 'shortinfo.discountamount.nozero'|trans }}");
                $(this).find(':submit').removeAttr('disabled');
                return false;
            } else if (payamount < feeamountdiscounted && $("form .fee-item:checked").length > 1) {
                alert("{{ 'shortinfo.pay.lessthan.fee.oneitem'|trans }}");
                $(this).find(':submit').removeAttr('disabled');
                return false;
            }
        } else {
            if (payamount > feeamount) {
                alert("{{ 'shortinfo.pay.notbiggerthan.fee'|trans }}");
                $(this).find(':submit').removeAttr('disabled');
                return false;
            } else if (payamount < feeamount && $("form .fee-item:checked").size() > 1) {
                alert("{{ 'shortinfo.pay.lessthan.fee.oneitem'|trans }}");
                $(this).find(':submit').removeAttr('disabled');
                return false;
            } else if (payamount <= 0 || $("form .fee-item:checked").length < 1) {
            	alert("{{ 'shortinfo.pay.nozero'|trans }}");
            	$(this).find(':submit').removeAttr('disabled');
            	return false;
            }
        }

        return true;
    });

});
</script>

{% endblock content %}
